<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rohit Bhaiya Chatbot</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg: #1e0a3c;
      --sidebar-bg: #2e1a68;
      --primary: #7b2ff7;
      --hover: #5a189a;
      --bot-msg: #bda0ff;
      --text-color: #eee;
      --input-bg: #fff;
      --input-text: #000;
    }
    body.light {
      --bg: #f1f1f1;
      --sidebar-bg: #e4e4e4;
      --primary: #7b2ff7;
      --hover: #5a189a;
      --bot-msg: #d3bfff;
      --text-color: #111;
      --input-bg: #fff;
      --input-text: #000;
    }
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-color);
    }
  #container {
  display: flex;
  height: 100vh;
  max-width: 1400px;
  margin: auto;
}
    #sidebar {
      width: 25%;
      background: var(--sidebar-bg);
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }
    #new-chat-btn {
      padding: 10px;
      background: var(--primary);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #search-input {
      padding: 8px 12px;
      border-radius: 20px;
      border: none;
      outline: none;
      font-size: 14px;
    }
    #history-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
      background: var(--hover);
    }
    #history-list div {
      background: var(--primary);
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
      position: relative;
    }
    #history-list div:hover {
      background: var(--bot-msg);
      color: black;
    }
    #history-list div .time {
      position: absolute;
      right: 8px;
      top: 8px;
      font-size: 11px;
      opacity: 0.7;
    }
    #main {
      width: 75%;
      display: flex;
      flex-direction: column;
      padding: 15px;
    }
    #profile-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    #profile-info {
      display: flex;
      align-items: center;
    }
    #profile-pic {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-right: 10px;
    }
    #chat-window {
      flex: 1;
      background: var(--sidebar-bg);
      padding: 10px;
      border-radius: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      margin: 5px 0;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .user {
      align-self: flex-end;
      background: var(--primary);
      color: white;
    }
    .bot {
      align-self: flex-start;
      background: var(--bot-msg);
      color: black;
    }
    #input-area {
      display: flex;
      gap: 10px;
    }
    #input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      background: var(--input-bg);
      color: var(--input-text);
      outline: none;
    }
    #send-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
    }
    #theme-toggle {
      font-size: 20px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-color);
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="sidebar">
      <button id="new-chat-btn">+ New Chat</button>
      <input type="text" id="search-input" placeholder="Search chats..." autocomplete="off" />
      <div id="history-list" title="Chat History"></div>
    </div>

    <div id="main">
      <div id="profile-bar">
        <div id="profile-info">
          <img src="./rohitnegipick.jpeg" id="profile-pic" alt="Rohit Bhaiya" />
          <div>
            <div style="font-weight:bold; font-size:18px;">Rohit Bhaiya ðŸ’»</div>
            <div style="font-size:13px; opacity:0.7;">Online</div>
          </div>
        </div>

        <!-- ðŸ”¥ Theme + Sign-in together -->
        <div style="display: flex; align-items: center; gap: 10px;">
          <button id="theme-toggle" title="Toggle theme">&#9728;</button>
          <div id="google-signin-btn"></div>
        </div>
      </div>

      <div id="chat-window"></div>
      <div id="input-area">
        <input id="input" type="text" placeholder="Ask Rohit Bhaiya..." autocomplete="off" />
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <script>
    function handleCredentialResponse(response) {
      console.log("Encoded JWT ID token: " + response.credential);
      alert("Google Sign-In Successful!");
    }

    const body = document.body;
    const themeToggle = document.getElementById("theme-toggle");

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "YOUR_CLIENT_ID_HERE.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });

      renderSignInBtn();

      // Theme switch logic
      themeToggle.onclick = () => {
        body.classList.toggle("light");
        themeToggle.innerHTML = body.classList.contains("light") ? "\u263E" : "\u2600";
        renderSignInBtn(); // re-render sign-in button based on theme
      };
    };

    function renderSignInBtn() {
      google.accounts.id.renderButton(
        document.getElementById("google-signin-btn"),
        {
          theme: body.classList.contains("light") ? "outline" : "filled_black",
          size: "large",
          type: "standard",
          text: "signin_with"
        }
      );
    }

    // ðŸ§  Chat logic below
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send-btn");
    const chatWindow = document.getElementById("chat-window");
    const newChatBtn = document.getElementById("new-chat-btn");
    const historyList = document.getElementById("history-list");
    const searchInput = document.getElementById("search-input");

    let chatHistory = [];
    let currentChat = [];

    function formatTime(date) {
      let h = date.getHours();
      let m = date.getMinutes();
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      m = m < 10 ? "0" + m : m;
      return `${h}:${m} ${ampm}`;
    }

    function renderMessages() {
      chatWindow.innerHTML = "";
      currentChat.forEach(msg => {
        const div = document.createElement("div");
        div.className = `message ${msg.sender}`;
        div.textContent = msg.text;
        chatWindow.appendChild(div);
      });
      chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: "smooth" });
    }

    function addMessage(text, sender) {
      currentChat.push({ text, sender, time: new Date() });
      renderMessages();
    }

    function renderHistory(filter = "") {
      historyList.innerHTML = "";
      chatHistory.forEach((chat, index) => {
        const firstUserMsg = chat.find(m => m.sender === 'user');
        if (firstUserMsg && firstUserMsg.text.toLowerCase().includes(filter.toLowerCase())) {
          const div = document.createElement("div");
          div.textContent = firstUserMsg.text.slice(0, 40);
          div.title = firstUserMsg.text;
          div.onclick = () => {
            currentChat = [...chat];
            renderMessages();
          };
          const timeSpan = document.createElement("span");
          timeSpan.className = "time";
          timeSpan.textContent = formatTime(firstUserMsg.time || new Date());
          div.appendChild(timeSpan);
          historyList.appendChild(div);
        }
      });
    }

    newChatBtn.onclick = () => {
      if (currentChat.length) chatHistory.push([...currentChat]);
      currentChat = [];
      renderMessages();
      renderHistory();
    };

    searchInput.oninput = () => {
      renderHistory(searchInput.value);
    };

    sendBtn.onclick = async () => {
      const userMsg = input.value.trim();
      if (!userMsg) return;
      addMessage(userMsg, "user");
      input.value = "";

      const typingMsg = { text: "Typing...", sender: "bot", time: new Date() };
      currentChat.push(typingMsg);
      renderMessages();

      try {
        const res = await fetch("https://rohitnegi-chatbot.onrender.com/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userMsg })
        });

        if (!res.ok) throw new Error("Server error");

        const data = await res.json();
        currentChat.pop();
        addMessage(data.reply, "bot");

      } catch (error) {
        currentChat.pop();
        addMessage("Server se response nahi mila, try again later.", "bot");
        console.error(error);
      }
    };

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    renderHistory();
    renderMessages();
  </script>
</body>
</html>
